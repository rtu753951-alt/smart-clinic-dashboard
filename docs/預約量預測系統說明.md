# 預約量預測系統 - 實施說明

## 📋 系統概述

作為資深醫美顧問，本系統基於歷史資料和醫美產業規律，預測未來 7/30/90 天的預約趨勢。

---

## 🎯 核心功能

### 1. **智能預測引擎**

- 從歷史資料學習基準預約量
- 應用醫美產業季節規律
- 添加隨機變化避免完全複製過去

### 2. **三層資料顯示**

- **實際預約**（藍色實線）：已有的預約資料
- **趨勢預測**（橙色虛線）：對已有資料的趨勢預測
- **未來預測**（紫色虛線）：純預測資料

### 3. **視覺化區分**

- 實線 = 實際資料
- 虛線 = 預測資料
- 不同顏色 = 不同類型

---

## 📊 預測規則

### 週末效應

```
週末預約量 = 基準 × 1.15 ~ 1.20
增加 15% ~ 20%
```

### 季節規律

#### 🔥 旺季（預約增加）

| 時期                   | 增幅 | 原因                   |
| ---------------------- | ---- | ---------------------- |
| 農曆年前 4 週          | +40% | 年前保養需求           |
| 11-12 月               | +50% | 年度高峰、皮膚保養旺季 |
| 母親節週 (5 月第 2 週) | +60% | 節日促銷               |
| 3-5 月                 | +20% | 年後上升期             |

#### ❄️ 淡季（預約減少）

| 時期            | 減幅 | 原因       |
| --------------- | ---- | ---------- |
| 農曆年後 1 個月 | -30% | 年後恢復期 |
| 5-6 月          | -30% | 夏季淡季   |
| 10 月           | -25% | 淡季       |

---

## 🔮 預測方法

### Step 1: 學習歷史資料

```typescript
// 計算基準預約量（中位數 70% + 平均數 30%）
const baseline = median * 0.7 + average * 0.3;

// 範例：
// 中位數 = 15 筆/天
// 平均數 = 18 筆/天
// 基準 = 15 * 0.7 + 18 * 0.3 = 15.9 筆/天
```

### Step 2: 計算星期係數

```typescript
// 從歷史資料學習每個星期幾的預約模式
// 週一: 0.9, 週二: 0.95, ..., 週六: 1.2, 週日: 1.15
```

### Step 3: 應用季節係數

```typescript
// 根據日期判斷季節係數
// 11月 → 1.5 (年度高峰)
// 農曆年前 → 1.4 (旺季)
// 5-6月 → 0.7 (淡季)
```

### Step 4: 計算預測值

```typescript
預測值 = 基準 × 季節係數 × 星期係數 × (1 + 隨機變化)

// 範例（11月週六）：
// 基準 = 15.9
// 季節係數 = 1.5 (11月高峰)
// 星期係數 = 1.2 (週六)
// 隨機變化 = -5% ~ +5%
// 預測 = 15.9 × 1.5 × 1.2 × 1.03 = 29.5 ≈ 30 筆
```

### Step 5: 添加隨機變化

```typescript
// 避免完全複製過去，添加 ±15% 隨機變化
const variation = (Math.random() - 0.5) * 2 * 0.15;
predictedValue = baseValue * (1 + variation);
```

---

## 📈 圖表說明

### 資料集

#### 1. 實際預約（藍色實線）

- **顏色**: #4A90E2 (藍色)
- **樣式**: 實線，填充
- **點**: 圓形，較大
- **說明**: 已有的實際預約資料

#### 2. 趨勢預測（橙色虛線）

- **顏色**: #FFA500 (橙色)
- **樣式**: 虛線 [5, 5]
- **點**: 三角形，較小
- **說明**: 對已有資料的趨勢預測（可能變化 ±15%）

#### 3. 未來預測（紫色虛線）

- **顏色**: #9B59B6 (紫色)
- **樣式**: 虛線 [10, 5]
- **點**: 圓形，較小
- **說明**: 純預測資料（基於歷史與季節規律）

### Tooltip 資訊

```
12/20 (五)
實際預約: 18 筆預約
趨勢預測（已有資料）: 20 筆預約
趨勢預測可能變化 ±15%
```

```
12/25 (三)
未來預測: 22 筆預約
預測基於歷史資料與季節規律
```

---

## 💡 預測範例

### 情境：2025 年 12 月 16 日起，預測未來 30 天

#### 12 月下旬（年度高峰）

```
12/20 (五)
- 基準: 16 筆
- 季節係數: 1.5 (12月高峰)
- 星期係數: 1.0 (週五)
- 預測: 16 × 1.5 × 1.0 × 1.05 = 25 筆

12/21 (六)
- 基準: 16 筆
- 季節係數: 1.5 (12月高峰)
- 星期係數: 1.2 (週六)
- 預測: 16 × 1.5 × 1.2 × 0.98 = 28 筆
```

#### 1 月中旬（農曆年前）

```
1/15 (三)
- 基準: 16 筆
- 季節係數: 1.4 (農曆年前4週)
- 星期係數: 0.95 (週三)
- 預測: 16 × 1.4 × 0.95 × 1.02 = 22 筆
```

#### 2 月初（農曆年後）

```
2/5 (三)
- 基準: 16 筆
- 季節係數: 0.7 (農曆年後淡季)
- 星期係數: 0.95 (週三)
- 預測: 16 × 0.7 × 0.95 × 0.97 = 10 筆
```

---

## 🔧 技術實現

### 檔案結構

```
src/
├── logic/
│   └── forecast/
│       └── appointmentForecast.ts  (預測引擎)
└── pages/
    └── appointmentsPage.ts         (圖表渲染)
```

### 核心函數

#### `generateForecast()`

```typescript
export function generateForecast(
  appointments: AppointmentRecord[],
  startDate: Date,
  days: number
): ForecastData[];
```

**功能**：

- 分析歷史資料
- 計算基準和係數
- 生成預測資料

**返回**：

```typescript
interface ForecastData {
  date: string;
  actual?: number; // 實際預約數
  predicted?: number; // 預測預約數
  trend?: number; // 趨勢預測
  isPrediction: boolean; // 是否為預測
  seasonalFactor: number; // 季節係數
  dayOfWeek: number; // 星期幾
}
```

#### `formatDateLabel()`

```typescript
export function formatDateLabel(dateStr: string): string;
```

**功能**：格式化日期顯示
**範例**：`"2025-12-20"` → `"12/20 (五)"`

---

## ✅ 驗證

### 編譯測試

```bash
npm run build
# ✓ 編譯成功
```

### 功能測試

1. ✅ 顯示未來 7/30/90 天預測
2. ✅ 實際資料用實線顯示
3. ✅ 預測資料用虛線顯示
4. ✅ 不同類型用不同顏色
5. ✅ Tooltip 顯示詳細資訊
6. ✅ 圖例說明清楚

---

## 📝 使用方式

### 1. 開啟預約分析頁面

點擊側邊欄「預約分析」

### 2. 查看預測圖表

- 預設顯示未來 30 天
- 藍色實線 = 實際資料
- 橙色虛線 = 趨勢預測
- 紫色虛線 = 未來預測

### 3. 切換時間範圍

- 點擊「7 天」/「30 天」/「90 天」按鈕
- 圖表自動更新

### 4. 查看詳細資訊

- 滑鼠移到資料點上
- 顯示預約數量和預測說明

---

## 🎯 預測準確性

### 影響因素

#### 正面因素

- ✅ 歷史資料豐富
- ✅ 季節規律明顯
- ✅ 週末效應穩定

#### 負面因素

- ❌ 突發事件（疫情、天災）
- ❌ 促銷活動變化
- ❌ 競爭對手影響

### 建議使用方式

1. **短期預測（7 天）**：準確度較高，可作為排班參考
2. **中期預測（30 天）**：參考趨勢，提前準備
3. **長期預測（90 天）**：了解季節變化，規劃策略

---

## 🔄 未來改進

### 可能的增強功能

1. **機器學習模型**

   - 使用 LSTM 或 ARIMA 模型
   - 提高預測準確度

2. **外部因素整合**

   - 天氣資料
   - 節假日資料
   - 促銷活動資料

3. **信心區間**

   - 顯示預測的上下限
   - 提供不確定性指標

4. **自動調整**
   - 根據實際資料自動校正
   - 持續學習優化

---

**建立日期**: 2025-12-16  
**版本**: v1.0  
**狀態**: ✅ 已完成並測試
