# 新增營運概要指標卡 - 測試說明

## ✅ 已完成的修改

### 1. 新增兩張營運指標卡

#### 📌 卡片 1：今日營收狀態（Revenue Status）

**位置**：在「營運概要」頁面，位於主要 4 張卡片下方、AI 區上方

**顯示內容**：

- 今日營收狀態：高於預期 / 符合預期 / 低於預期
- vs 昨日（百分比變化）
- vs 近 7 日平均（百分比變化）

**計算邏輯**：

- 僅使用 `appointments` 中 `status === "completed"` 的資料
- 營收 = 依 `service_item` 對應 `services.price`
- 狀態判斷：
  - 今日 > 7 日平均 +10% → 「高於預期」（綠色）
  - ±10% 內 → 「符合預期」（青色）
  - < -10% → 「低於預期」（琥珀色）

#### 📌 卡片 2：本月顧客回診率（Return Visit Rate）

**位置**：與營收狀態卡並排

**顯示內容**：

- 本月回診率（百分比）
- 進度條視覺化
- 顧客黏著度狀態（穩定/普通/偏低）
- 回診客數 / 總客數

**計算邏輯**：

- 使用 `appointments` 資料
- 回診客定義：同一 `customer_id` 在本月內有 ≥2 次 completed 預約
- 回診率 = 回診客人數 / 本月有完成預約的總客戶數
- 狀態判斷：
  - ≥45%：穩定（綠色）
  - 30%–44%：普通（琥珀色）
  - <30%：偏低（紅色）

---

## 📂 修改的檔案

### 1. `src/pages/overviewPage.ts`

- ✅ 新增 `updateRevenueStatus()` 函數
- ✅ 新增 `updateReturnVisitRate()` 函數
- ✅ 在 `initOverviewPage()` 中呼叫這兩個函數
- ✅ 支援月份切換時自動重新計算

### 2. `index.html`

- ✅ 在營運概要頁面新增兩張卡片的 HTML 結構
- ✅ 使用 `id="revenue-status-content"` 和 `id="return-visit-content"` 作為動態內容容器

---

## 🧪 測試步驟

### 方法 1：使用本地伺服器（推薦）

1. 開啟終端機，執行：

   ```bash
   cd d:\AI專題\clinic_dashboard_ai
   python -m http.server 8000
   ```

2. 開啟瀏覽器，前往：

   ```
   http://localhost:8000
   ```

3. 檢查項目：
   - ✅ 頁面載入後，在「營運概要」頁面可以看到兩張新卡片
   - ✅ 營收狀態卡顯示：狀態、vs 昨日、vs 近 7 日平均
   - ✅ 回診率卡顯示：百分比、進度條、狀態文字
   - ✅ 切換月份選擇器時，回診率會重新計算

### 方法 2：直接開啟檔案

1. 用瀏覽器直接開啟：

   ```
   d:\AI專題\clinic_dashboard_ai\index.html
   ```

2. 注意：某些瀏覽器可能因為 CORS 政策無法載入 CSV 資料，建議使用方法 1

---

## 🎨 UI 特色

### 營收狀態卡

- 使用小字體，不強調金額
- 顏色編碼：
  - 綠色 (#10b981)：高於預期
  - 青色 (#06b6d4)：符合預期
  - 琥珀色 (#f59e0b)：低於預期
- 百分比變化使用 +/- 符號

### 回診率卡

- 大字顯示百分比
- 動態進度條視覺化
- 顏色編碼：
  - 綠色：穩定 (≥45%)
  - 琥珀色：普通 (30-44%)
  - 紅色：偏低 (<30%)
- 顯示實際回診客數與總客數

---

## 🔧 技術細節

### 資料來源

- **不新增資料表**：僅使用既有的 `appointments`、`services`、`customers` 資料
- **不顯示金額明細**：營收卡只顯示趨勢與比率
- **不顯示客戶列表**：回診率卡只顯示統計數字

### 月份切換支援

- 兩個函數都會在 `initOverviewPage()` 中被呼叫
- 當使用者切換月份選擇器（`global-month-selector`）時，會觸發頁面重新初始化
- 回診率會根據當前選擇的月份重新計算

### 日期計算

- 使用 JavaScript `Date` 物件進行日期運算
- 營收狀態：計算今天、昨天、過去 7 天
- 回診率：使用 `currentDashboardMonth` 全域變數或當前月份

---

## 📊 範例輸出

### 營收狀態卡範例

```
今日營收狀態          高於預期

vs 昨日              +15%
vs 近 7 日平均        +12%
```

### 回診率卡範例

```
本月回診率            52%
[████████████░░░░░░]

顧客黏著度：穩定

26 / 50 位顧客回診
```

---

## ⚠️ 注意事項

1. **不破壞既有功能**：所有既有卡片與邏輯保持不變
2. **純補充型指標**：不影響其他頁面或功能
3. **效能考量**：計算邏輯簡單高效，不會影響頁面載入速度
4. **樣式一致性**：使用與其他 overview KPI 卡相同的樣式系統

---

## 🚀 下一步

如需調整：

- 修改狀態判斷閾值（目前：±10% 和 30%/45%）
- 調整顏色配置
- 新增更多統計資訊
- 加入圖表視覺化

所有修改都集中在 `overviewPage.ts` 中，易於維護和擴展。
