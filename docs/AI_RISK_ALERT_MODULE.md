# AI 風險預警模組 v2.0 - 完整說明

## 🎯 核心改進

### v1.0 → v2.0 主要變更

| 項目         | v1.0                             | v2.0                            |
| ------------ | -------------------------------- | ------------------------------- |
| **分析單位** | 人員類型（doctor, nurse）        | **個人 + 療程**                 |
| **資料來源** | staff_workload.csv               | **appointments + services**     |
| **計算方式** | 工作次數 / 時段                  | **實際工時 / 可承受工時**       |
| **風險類型** | 5 類（負載/閒置/預約/療程/結構） | **2 大類：人力風險 + 療程風險** |
| **輸出格式** | 混合顯示                         | **分區顯示（人力/療程）**       |

## 📊 新版分析邏輯

### 一、人力風險（Staff Risk）

#### 判斷單位

- **個人層級**：以 `staff_name` 為唯一計算單位
- `staff_type` 僅用於分類顯示

#### 資料來源

```typescript
appointments(completed + scheduled + confirmed);
services(duration + buffer_time);
staff(staff_name + staff_type);
```

#### 營運假設

- 診所每日營運：9 小時
- 員工每日可工作：8 小時
- 排除狀態：`cancelled` / `no_show`

#### 計算公式

```
實際負載工時 = Σ (service.duration + buffer_time)
可承受工時 = 工作天數 × 8 小時
個人負載率 = (實際負載工時 / 可承受工時) × 100%
```

#### 風險分級

| 負載率 | 等級      | 圖示     | 說明                 |
| ------ | --------- | -------- | -------------------- |
| ≥ 90%  | 🔴 高風險 | critical | 過載，需立即調整     |
| 70-89% | 🟠 中風險 | warning  | 接近高檔，需持續觀察 |
| 30-69% | 🟢 正常   | normal   | 健康範圍             |
| < 30%  | 🔵 低利用 | low      | 閒置，可調整導流     |

#### 輸出範例

**簡要版：**

```
🔴 2 位醫師本月負載超過 90%，存在過載風險
🟠 1 位護理師本月負載偏高（70-89%），需持續觀察
🔵 1 位諮詢師利用率偏低，可調整導流策略
```

**詳細版：**

```
👤 一、人力風險（個人層級）

🔴 陳醫師（doctor）人力負載過高
  風險說明：陳醫師 本月負載率達 92%，已接近或超過可承受上限
  判斷依據：工作天數：22 天｜執行療程：186 次｜實際工時：176 / 176 小時
  💡 管理建議：建議調整未來兩週排班，分流部分高工時療程至其他人員，或增加休息時段
```

### 二、療程風險（Service Risk）

#### 判斷單位

- **療程層級**：以 `service_name` 為單位

#### 資料來源

```typescript
appointments(completed);
services(category / executor_role / duration);
staff(staff_type);
```

#### 風險類型

##### 1️⃣ 過度集中風險

**條件：**

- 單一療程佔全部預約 > 35%

**風險說明：**

- 營收與人力高度依賴單一療程
- 市場變化或人員異動風險高

**輸出範例：**

```
🟠 Pico Laser 預約高度集中（38%），營運依賴偏高
  風險說明：Pico Laser 佔本月總預約量 38%，營收與人力高度依賴單一療程
  判斷依據：共 450 筆預約，佔總量 1200 筆的 38%｜主要執行角色：therapist（2 人）
  💡 管理建議：建議分散療程組合，培訓其他療程能力，降低單一療程依賴風險
```

##### 2️⃣ 人力瓶頸風險

**條件：**

- 該療程 `executor_role` 對應的人員數 < 2
- 且療程預約數 > 總預約量 × 10%

**風險說明：**

- 任何人員請假即影響服務
- 擴張彈性不足

**輸出範例：**

```
🟠 Thermage 存在人力瓶頸風險
  風險說明：Thermage 僅由 1 位 doctor 執行，人力彈性不足
  判斷依據：本月 150 筆預約｜執行角色：doctor（1 人）｜任何人員請假即影響服務
  💡 管理建議：建議培訓備援人力，或建立跨角色支援機制
```

##### 3️⃣ 高工時療程風險

**條件：**

- 單次療程（duration + buffer）≥ 60 分鐘
- 且每人每日平均執行 ≥ 5 次

**風險說明：**

- 容易導致疲勞與品質下降
- 排程彈性受限

**輸出範例：**

```
🟠 Ultherapy 高工時療程風險
  風險說明：Ultherapy 單次耗時 90 分鐘，且每人每日平均執行 6 次
  判斷依據：本月 120 筆預約｜執行角色：doctor（2 人）｜容易導致疲勞與品質下降
  💡 管理建議：建議調整排班節奏，增加休息時段，或評估療程流程優化
```

## 🎨 UI 顯示格式

### 簡要版（營運概要卡片）

**限制：**

- 最多 3-4 行
- 僅顯示需要管理者注意的風險
- 使用圖示：🔴 🟠 🔵 ✅

**範例：**

```
🔴 2 位醫師本月負載超過 90%，存在過載風險
🟠 Pico Laser 預約高度集中（38%），營運依賴偏高
🔵 諮詢師整體利用率偏低，可調整導流策略
```

### 詳細版（彈窗）

**結構：**

```
🚨 本月 AI 風險預警（詳細版）

👤 一、人力風險（個人層級）
  [逐人顯示風險卡片]

💉 二、療程風險（療程層級）
  [逐療程顯示風險卡片]
```

**每個風險卡片包含：**

1. **風險說明**：簡潔描述風險狀況
2. **判斷依據**：具體數字（天數/次數/工時），可回推
3. **管理建議**：可行動的具體建議

## 💻 使用方式

```typescript
import { generateRiskAlerts } from "./ai/riskAlertEngine.js";

const riskAlerts = generateRiskAlerts({
  appointments: dataStore.appointments,
  services: dataStore.services,
  staff: dataStore.staff,
  targetMonth: "2024-01",
});

// 簡要摘要（卡片顯示）
console.log(riskAlerts.summary);
// ["🔴 2 位醫師本月負載超過 90%，存在過載風險", ...]

// 詳細分析（彈窗顯示）
console.log(riskAlerts.details);
// [{ type: "staff", level: "critical", ... }, ...]
```

## 🔍 Debug 方式

打開瀏覽器 Console，查看：

```
👤 個人工作負載分析: [
  { name: "陳醫師", type: "doctor", days: 22, hours: 176, count: 186 },
  { name: "李醫師", type: "doctor", days: 20, hours: 145, count: 150 },
  ...
]

  陳醫師 (doctor): {
    workDays: 22,
    totalHours: 176,
    maxCapacity: 176,
    loadRate: "100%"
  }
```

## 📝 語氣與風格

- **專業、冷靜、管理顧問視角**
- 不誇張、不製造恐慌
- 每個風險必須附「可行管理建議」
- 用詞偏「營運管理」，不是學術分析
- 定位：**診所營運長的提醒助理**

## ⚠️ 重要限制

1. **不使用職務平均值做風險結論**，只能作為背景資訊
2. **所有百分比需能回推實際數字**（天數/次數/工時）
3. **不提及外部因素**（疫情/經濟/天氣）
4. **不提及模型準確率**
5. **避免使用「建議持續觀察數據變化」超過一次**

## 🚀 下一步優化方向

1. **歷史趨勢比較**：與上月/去年同期比較
2. **預測性警告**：根據未來 30 天預約預測風險
3. **自動化建議**：根據風險自動生成排班調整建議
4. **風險優先級排序**：根據影響程度排序風險
5. **風險關聯分析**：分析人力風險與療程風險的關聯性
