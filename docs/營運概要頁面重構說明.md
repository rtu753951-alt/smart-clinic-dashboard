# 營運概要頁面重構說明

## 📋 重構目標

將營運概要頁面從混亂的單層結構重構為清晰的**四層語意結構**，讓經營者能夠：

1. **今天忙不忙** → 即時營運 KPI
2. **有沒有賺錢** → 經營成效摘要
3. **為什麼會這樣** → 營運分佈分析 + AI 洞察

---

## 🎯 重構後的四層結構

### **1️⃣ 即時營運 KPI**（Section 1 - 維持原樣）

- 今日預約
- 今日到診率
- 醫師出勤
- 護理/美療人數
- 診間使用率
- 設備使用率

**位置**：頁面最上方，橫向滑動卡片列
**樣式**：保持原有的 `kpi-strip` 和 `kpi-card`

---

### **2️⃣ 經營成效摘要**（Section 2 - 新增獨立區塊）

#### 📌 區塊特色

- **獨立的視覺區域**：淡藍色漸層背景 + 圓角邊框
- **清晰的區塊標題**：「經營成效摘要 / Business Performance Summary」
- **提升視覺權重**：使用 `metric-card` 樣式，帶圖標和漸層色

#### 📊 包含指標（3 張卡片）

**💰 今日營收狀態**

- 顯示內容：
  - 今日營收狀態（高於/符合/低於預期）
  - vs 昨日（百分比）
  - vs 近 7 日平均（百分比）
- 計算邏輯：**不變**（使用既有 `updateRevenueStatus()` 函數）
- 圖標：綠色漸層 `fa-dollar-sign`

**📊 本月營收**

- 顯示內容：
  - 本月累計營收總額（格式化數字，無貨幣符號）
  - 完成預約數
- 計算邏輯：**新增** `updateMonthlyRevenue()` 函數
  - 篩選本月 `status === "completed"` 的預約
  - 依 `service_item` 對應 `services.price` 計算總和
  - 不顯示明細，只顯示總額
- 圖標：藍色漸層 `fa-wallet`

**🔄 本月顧客回診率**

- 顯示內容：
  - 本月回診率（百分比）
  - 進度條視覺化
  - 顧客黏著度狀態
  - 回診客數 / 總客數
- 計算邏輯：**不變**（使用既有 `updateReturnVisitRate()` 函數）
- 圖標：紫色漸層 `fa-rotate`

#### 🎨 UI 設計重點

```html
<div class="business-summary-section">
  <div class="section-header">
    <h2 class="section-title">
      <i class="fa-solid fa-chart-line"></i>
      經營成效摘要
    </h2>
    <small>Business Performance Summary</small>
  </div>

  <div class="business-metrics-grid">
    <!-- 3 張 metric-card -->
  </div>
</div>
```

**CSS 特色**：

- `.business-summary-section`：淡藍色漸層背景，圓角邊框
- `.business-metrics-grid`：響應式 Grid，最小寬度 280px
- `.metric-card`：帶圖標的卡片，hover 效果，頂部光線動畫
- `.metric-icon`：48x48px 圓角圖標，漸層背景

---

### **3️⃣ 營運分佈分析**（Section 3 - 調整結構）

#### 📌 區塊特色

- **獨立的區塊標題**：「營運分佈分析 / Operations Distribution」
- **保持原有內容**：4 張卡片（醫師 Top3、療程 Top3、診間使用率、設備使用率）
- **樣式不變**：使用既有的 `overview-card` 和 `overview-main-grid`

#### 📊 包含卡片（4 張）

- 👨‍⚕️ 醫師 Top 3（本月）
- 🔥 熱門療程 Top 3（本月）
- 🏥 診間使用率（本月）
- ⚡ 設備使用率（本月）

**計算邏輯**：**完全不變**

---

### **4️⃣ AI 洞察分析**（Section 4 - 調整結構）

#### 📌 區塊特色

- **獨立的區塊標題**：「AI 洞察分析 / AI Insights」
- **保持原有內容**：2 張 AI 卡片
- **樣式不變**：使用既有的 `ai-overview-zone`

#### 📊 包含卡片（2 張）

- 🚨 AI 風險預警（摘要）
- 📊 AI 趨勢摘要（摘要）

**計算邏輯**：**完全不變**

---

## 🔧 技術實作細節

### **修改的檔案**

#### 1. `index.html`

**變更範圍**：第 160-340 行（overview section）

**主要修改**：

- 將原本的單層結構拆分為 4 個獨立區塊
- 每個區塊加上 `section-header` 和 `section-title`
- 經營成效摘要使用新的 `business-summary-section` 和 `metric-card`
- 營運分佈分析和 AI 洞察加上獨立的 wrapper

**新增的 CSS Class**：

- `.business-summary-section`
- `.business-metrics-grid`
- `.metric-card`
- `.metric-header`
- `.metric-icon`
- `.metric-title-group`
- `.metric-body`
- `.operations-analysis-section`
- `.ai-insights-section`
- `.section-header`
- `.section-title`

#### 2. `src/pages/overviewPage.ts`

**變更範圍**：

- 第 13-40 行：調整 `initOverviewPage()` 函數呼叫順序
- 第 560-618 行：新增 `updateMonthlyRevenue()` 函數

**主要修改**：

- 調整函數呼叫順序，符合新的 UI 結構（由上而下）
- 新增本月營收計算函數
- 加上清晰的註解標示四個區塊

**新增函數**：

```typescript
function updateMonthlyRevenue() {
  // 計算本月營收總額
  // 顯示完成預約數
  // 不展開明細
}
```

#### 3. `style.css`

**新增內容**：在檔案末尾加入約 180 行新樣式

**主要新增**：

- Section Headers 樣式
- Business Performance Summary 區塊樣式
- Metric Cards 樣式（帶圖標、漸層、動畫）
- Operations Analysis Section 樣式
- AI Insights Section 樣式
- 響應式調整

---

## ✅ 嚴格遵守的限制

### **不修改的部分**

❌ 所有 KPI 計算邏輯（`calcTodayKPI`, `getDoctorTop3`, `getTopTreatments` 等）
❌ 資料來源（`dataStore.appointments`, `dataStore.services`, `dataStore.staff`）
❌ 既有函數的內部邏輯（`updateRevenueStatus`, `updateReturnVisitRate` 等）
❌ Modal 彈窗機制（`bindOverviewCards`, `ModalManager`）
❌ AI 分析邏輯（`generateAITrendReport`, `generateRiskAlerts`）

### **只修改的部分**

✅ HTML 結構分組（加上 wrapper 和 section）
✅ CSS 樣式（新增區塊樣式、卡片樣式）
✅ 函數呼叫順序（符合新的 UI 結構）
✅ 新增本月營收計算函數（使用既有資料源）

---

## 📊 視覺層級對比

### **重構前**

```
├── KPI Strip (6 cards)
├── Doctor Top3
├── Treatment Top3
├── Room Usage
├── Equipment Usage
├── Revenue Status (混在中間)
├── Return Visit Rate (混在中間)
├── AI Alert
└── AI Trend
```

### **重構後**

```
1️⃣ 即時營運 KPI
   ├── 今日預約
   ├── 今日到診率
   ├── 醫師出勤
   ├── 護理/美療
   ├── 診間使用率
   └── 設備使用率

2️⃣ 經營成效摘要 ⭐ 新增獨立區塊
   ├── 💰 今日營收狀態
   ├── 📊 本月營收
   └── 🔄 本月顧客回診率

3️⃣ 營運分佈分析
   ├── 👨‍⚕️ 醫師 Top 3
   ├── 🔥 熱門療程 Top 3
   ├── 🏥 診間使用率
   └── ⚡ 設備使用率

4️⃣ AI 洞察分析
   ├── 🚨 AI 風險預警
   └── 📊 AI 趨勢摘要
```

---

## 🎨 設計理念

### **資訊層級**

1. **即時狀態**（今天忙不忙）→ KPI Strip
2. **經營結果**（有沒有賺錢）→ 經營成效摘要 ⭐
3. **原因分析**（為什麼會這樣）→ 營運分佈 + AI 洞察

### **視覺權重**

- **經營成效摘要**：獨立背景色、大圖標、漸層效果 → **高視覺權重**
- **營運分佈分析**：標準卡片樣式 → **中視覺權重**
- **AI 洞察分析**：標準卡片樣式 → **中視覺權重**

### **色彩語意**

- 💰 今日營收：綠色（#10b981）→ 成長、正向
- 📊 本月營收：藍色（#3b82f6）→ 穩定、專業
- 🔄 回診率：紫色（#8b5cf6）→ 黏著度、忠誠度

---

## 🧪 測試檢查清單

### **功能測試**

- [ ] 頁面載入後四個區塊正常顯示
- [ ] 今日營收狀態卡正常計算並顯示
- [ ] 本月營收卡正常計算並顯示（總額 + 完成預約數）
- [ ] 本月回診率卡正常計算並顯示
- [ ] 醫師 Top3、療程 Top3 正常顯示
- [ ] 診間使用率、設備使用率正常顯示
- [ ] AI 風險預警、AI 趨勢摘要正常顯示
- [ ] 切換月份選擇器時，本月營收和回診率會更新

### **樣式測試**

- [ ] 經營成效摘要區塊有獨立的背景色和邊框
- [ ] Metric cards 有圖標、漸層色、hover 效果
- [ ] Section headers 清晰可見，有圖標和英文副標題
- [ ] 響應式布局正常（桌面、平板、手機）
- [ ] 卡片 hover 效果正常（光線動畫、陰影）

### **邏輯測試**

- [ ] 所有既有計算邏輯未被修改
- [ ] Modal 彈窗功能正常
- [ ] 資料來源未被改變
- [ ] Console 沒有錯誤訊息

---

## 📝 後續優化建議

### **可選的進階功能**

1. **本月營收卡**：加入 vs 上月的比較（需要歷史資料）
2. **經營成效摘要**：加入第 4 張卡片（例如：本月新客數）
3. **動畫效果**：區塊進入時的漸入動畫
4. **響應式優化**：手機版改為垂直堆疊

### **不建議的修改**

❌ 不要在經營成效摘要中顯示客戶列表
❌ 不要在本月營收中顯示每日明細
❌ 不要破壞既有的 Modal 彈窗邏輯
❌ 不要修改 AI 分析的計算邏輯

---

## 🚀 部署說明

### **檔案清單**

- ✅ `index.html`（已修改）
- ✅ `src/pages/overviewPage.ts`（已修改）
- ✅ `style.css`（已新增樣式）
- ✅ `dist/pages/overviewPage.js`（已編譯）

### **部署步驟**

1. 確認 TypeScript 已編譯：`npx tsc`
2. 重新啟動本地伺服器：`python -m http.server 8000`
3. 開啟瀏覽器測試：`http://localhost:8000`
4. 檢查 Console 是否有錯誤
5. 測試月份切換功能

---

## 📚 程式碼範例

### **新增的本月營收函數**

```typescript
function updateMonthlyRevenue() {
  const currentMonth =
    (window as any).currentDashboardMonth ||
    new Date().toISOString().slice(0, 7);

  const monthAppointments = dataStore.appointments.filter(
    (apt) =>
      apt.status === "completed" &&
      apt.date.startsWith(currentMonth) &&
      apt.service_item
  );

  const totalRevenue = monthAppointments.reduce((sum, apt) => {
    const service = dataStore.services.find(
      (s) => s.service_name === apt.service_item
    );
    return sum + (service?.price || 0);
  }, 0);

  const completedCount = monthAppointments.length;

  // 格式化數字（無貨幣符號）
  const formattedRevenue = totalRevenue.toLocaleString("zh-TW");

  // 更新 UI...
}
```

### **新增的 HTML 結構**

```html
<div class="business-summary-section">
  <div class="section-header">
    <h2 class="section-title">
      <i class="fa-solid fa-chart-line"></i>
      經營成效摘要
    </h2>
    <small>Business Performance Summary</small>
  </div>

  <div class="business-metrics-grid">
    <article class="metric-card">
      <div class="metric-header">
        <div class="metric-icon" style="background: linear-gradient(...);">
          <i class="fa-solid fa-dollar-sign"></i>
        </div>
        <div class="metric-title-group">
          <h3>今日營收狀態</h3>
          <small>Today's Revenue</small>
        </div>
      </div>
      <div class="metric-body" id="revenue-status-content">
        <!-- Dynamically generated -->
      </div>
    </article>
    <!-- 其他 2 張卡片... -->
  </div>
</div>
```

---

**重構完成！** 🎉

現在營運概要頁面有清晰的四層結構，經營者可以一眼看出：

1. 今天忙不忙（即時 KPI）
2. 有沒有賺錢（經營成效）
3. 為什麼會這樣（營運分佈 + AI 洞察）
