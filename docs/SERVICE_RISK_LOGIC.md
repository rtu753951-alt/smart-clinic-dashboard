# 療程風險分析 - 完整邏輯說明

## 🎯 核心改進

### 問題修正

- ❌ **舊版問題**：可能出現 Infinity 或 0 人執行的錯誤
- ✅ **新版解決**：使用需求工時/供給工時計算，避免除以 0

### 計算邏輯

#### 1. 資料來源

```typescript
appointments(completed); // 本月已完成預約
services(duration + buffer_time + executor_role); // 療程資訊
staff(staff_type + status); // 人員資訊
```

#### 2. 營運假設

- 診所每日營運：9 小時
- 員工每日最多工作：8 小時
- 每月工作天數：22 天
- 每人每月可用工時：22 × 8 = **176 小時**

#### 3. 計算步驟

**步驟 1：統計療程預約數**

```typescript
本月 Pico Laser 預約：450 筆
```

**步驟 2：找出執行角色**

```typescript
Pico Laser 的 executor_role = "therapist"
```

**步驟 3：計算可執行人數**

```typescript
可執行人數 = staff.filter(
  (s) => s.staff_type === "therapist" && s.status === "active"
).length;

// 例如：2 人
```

**步驟 4：計算需求工時**

```typescript
單次療程時間 = duration + buffer_time
// 例如：30 + 10 = 40 分鐘

需求工時 = (預約數 × 單次療程時間) / 60
// 例如：(450 × 40) / 60 = 300 小時
```

**步驟 5：計算供給工時**

```typescript
供給工時 = 可執行人數 × 每人每月可用工時
// 例如：2 × 176 = 352 小時
```

**步驟 6：計算負載率**

```typescript
負載率 = (需求工時 / 供給工時) × 100%
// 例如：(300 / 352) × 100% = 85%
```

## 🚦 風險分級

| 負載率  | 等級      | 圖示     | 說明                       | 管理建議                     |
| ------- | --------- | -------- | -------------------------- | ---------------------------- |
| > 100%  | 🔴 高風險 | critical | 需求超過供給，嚴重排程壓力 | 增加人力、調整排班、分流預約 |
| 80-100% | 🟠 偏高   | warning  | 接近供給上限，彈性受限     | 持續觀察、增加備援人力       |
| 50-80%  | 🟡 正常   | normal   | 健康範圍                   | 維持現狀                     |
| < 50%   | 🔵 低     | low      | 供給充足                   | 可考慮增加預約               |
| 0 人    | 🔴 無人力 | critical | 無可執行人員               | 立即招募或培訓               |

## 📊 輸出範例

### 範例 1：高工時療程風險

**輸入資料：**

- 療程：Pico Laser
- 本月預約：450 筆
- 單次時間：40 分鐘（30 + 10）
- 執行角色：therapist
- 可執行人數：2 人

**計算過程：**

```
需求工時 = (450 × 40) / 60 = 300 小時
供給工時 = 2 × 176 = 352 小時
負載率 = (300 / 352) × 100% = 85%
```

**輸出：**

```
🟠 Pico Laser 療程負載偏高（85%）

風險說明：
Pico Laser 需求工時接近供給上限，排程彈性受限

判斷依據：
本月預約：450 筆｜需求工時：300 小時｜供給工時：352 小時｜可執行人數：2 人（therapist）

💡 管理建議：
建議持續觀察，必要時調整排班或增加備援人力
```

### 範例 2：無可執行人力

**輸入資料：**

- 療程：Thermage
- 本月預約：50 筆
- 單次時間：90 分鐘（75 + 15）
- 執行角色：doctor
- 可執行人數：0 人（所有 doctor 的 status 都不是 active）

**計算過程：**

```
需求工時 = (50 × 90) / 60 = 75 小時
供給工時 = 0 × 176 = 0 小時
負載率 = N/A（避免除以 0）
```

**輸出：**

```
🔴 Thermage 無可執行人力

風險說明：
Thermage 本月有 50 筆預約，但無可執行人員（doctor）

判斷依據：
本月預約：50 筆｜需求工時：75 小時｜可執行人數：0 人

💡 管理建議：
建議立即招募或培訓相關人員，或暫停該療程預約
```

### 範例 3：過度集中風險

**輸入資料：**

- 療程：Pico Laser
- 本月預約：450 筆
- 總預約：1000 筆
- 佔比：45%

**輸出：**

```
🟠 Pico Laser 預約高度集中（45%）

風險說明：
Pico Laser 佔本月總預約量 45%，營收與人力高度依賴單一療程

判斷依據：
本月預約：450 筆｜佔總預約：1000 筆的 45%｜可執行人數：2 人（therapist）

💡 管理建議：
建議分散療程組合，培訓其他療程能力，降低單一療程依賴風險
```

### 範例 4：人力瓶頸風險

**輸入資料：**

- 療程：Ultherapy
- 本月預約：150 筆
- 總預約：1000 筆
- 佔比：15%
- 可執行人數：1 人

**輸出：**

```
🟠 Ultherapy 存在人力瓶頸風險

風險說明：
Ultherapy 僅由 1 位 doctor 執行，人力彈性不足

判斷依據：
本月預約：150 筆｜可執行人數：1 人（doctor）｜任何人員請假即影響服務

💡 管理建議：
建議培訓備援人力，或建立跨角色支援機制
```

## 🔍 Debug 方式

打開瀏覽器 Console，查看：

```
💉 療程風險分析: {
  totalAppointments: 1000,
  serviceCount: 8
}

  Pico Laser: {
    count: 450,
    executorRole: "therapist",
    availableStaff: 2,
    demandHours: 300,
    supplyHours: 352,
    loadRate: "85%"
  }

  Thermage: {
    count: 50,
    executorRole: "doctor",
    availableStaff: 0,
    demandHours: 75,
    supplyHours: 0,
    loadRate: "N/A"
  }
```

## ⚠️ 重要注意事項

1. **避免 Infinity**

   - 當 `availableStaffCount === 0` 時，直接返回「無可執行人力」警告
   - 不計算負載率，避免除以 0

2. **只計算 active 人員**

   - 使用 `staff.filter(s => s.status === "active")`
   - 確保只計算實際可用的人力

3. **使用實際工時**

   - 不使用「平均每日執行次數」等模糊指標
   - 直接計算「需求工時 / 供給工時」

4. **可回推的數字**
   - 所有百分比都能回推實際數字
   - 例如：85% = 300 小時 / 352 小時

## 📝 與舊版的差異

| 項目         | 舊版                                 | 新版                     |
| ------------ | ------------------------------------ | ------------------------ |
| **計算單位** | 平均每人每日執行次數                 | 需求工時 / 供給工時      |
| **風險判斷** | 單次時間 ≥ 60 分鐘 且 平均 ≥ 5 次/日 | 負載率 > 80%             |
| **0 人處理** | 可能出現 Infinity                    | 直接顯示「無可執行人力」 |
| **可解釋性** | 較模糊                               | 明確的工時數字           |
| **可行動性** | 較籠統                               | 具體的人力/工時建議      |
