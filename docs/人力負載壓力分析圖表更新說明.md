# äººåŠ›è² è¼‰å£“åŠ›åˆ†æåœ–è¡¨ - æ›´æ–°èªªæ˜

## ğŸ“‹ è®Šæ›´æ‘˜è¦

æ ¹æ“šæ‚¨çš„éœ€æ±‚ï¼Œå·²å°‡äººåŠ›åˆ†æé é¢çš„è² è¼‰å£“åŠ›åˆ†æå¾ã€Œå£“åŠ›æ¢ã€æ”¹ç‚ºã€Œåœ–è¡¨ã€ï¼Œä¸¦å¯¦æ–½ä»¥ä¸‹èª¿æ•´ï¼š

### âœ… å·²å®Œæˆé …ç›®

1. **å·¥æ™‚è¨ˆç®—è¦å‰‡**

   - ç¸½å·¥æ™‚ = è·å‹™ç¸½äººæ•¸ Ã— 8 å°æ™‚/å¤© Ã— 7 å¤©/é€± Ã— 4 é€±/æœˆ
   - è·å‹™äººæ•¸å¾ `staff.csv` å‹•æ…‹è¨ˆç®—ï¼ˆstatus = 'active'ï¼‰

2. **å¯¦éš›å·¥æ™‚ç¯©é¸è¦å‰‡**ï¼ˆåŸºæº–æ—¥ï¼š2025-12-16ï¼‰

   - **ä»Šå¤©ä¹‹å‰ï¼ˆä¸å«ä»Šå¤©ï¼‰**ï¼šåªè¨ˆç®— `completed` çš„é ç´„
   - **ä»Šå¤©åŠä¹‹å¾Œï¼ˆå«ä»Šå¤©ï¼‰**ï¼šæ‰€æœ‰é ç´„éƒ½ç´å…¥è¨ˆç®—ï¼ˆä¸ç®¡ `completed`ã€`no_show`ã€`cancelled`ï¼‰

3. **é†«å¸«ä»‹å…¥æ¯”ä¾‹æ¨¡å‹**

   - å¥—ç”¨èˆ‡ `staffWorkloadBars.ts` å’Œ `humanRiskEngine.ts` ç›¸åŒçš„ä»‹å…¥æ¯”ä¾‹
   - Inject/RF: é†«å¸« 35%
   - Laser: é†«å¸« 15%ã€ç¾ç™‚å¸« 100%
   - Drip: é†«å¸« 10%ã€è­·ç†å¸« 100%
   - Consultation: é†«å¸« 30%ã€è«®è©¢å¸« 70%

4. **åœ–è¡¨åŒæ­¥**

   - èˆ‡å³ä¸Šæ–¹å…¨åŸŸæœˆä»½é¸å–®ï¼ˆ`#global-month-selector`ï¼‰åŒæ­¥
   - æœˆä»½è®Šæ›´æ™‚è‡ªå‹•é‡æ–°æ¸²æŸ“åœ–è¡¨

5. **äº‚ç¢¼ä¿®æ­£**
   - æ‰€æœ‰æ–‡å­—å·²æ”¹ç‚ºç¹é«”ä¸­æ–‡
   - ä½¿ç”¨ `'Noto Sans TC'` å­—é«”ç¢ºä¿ä¸­æ–‡æ­£ç¢ºé¡¯ç¤º

---

## ğŸ“ ä¿®æ”¹æª”æ¡ˆæ¸…å–®

### 1. **æ–°å¢æª”æ¡ˆ**

#### `src/logic/staff/staffWorkloadChart.ts`

- æ–°å»ºçš„äººåŠ›è² è¼‰å£“åŠ›åˆ†æåœ–è¡¨æ¨¡çµ„
- åŒ…å«ä»¥ä¸‹å‡½æ•¸ï¼š
  - `calculateStaffWorkloadData()`: è¨ˆç®—äººåŠ›è² è¼‰è³‡æ–™
  - `renderStaffWorkloadChart()`: æ¸²æŸ“åœ–è¡¨
  - `initStaffWorkloadChart()`: åˆå§‹åŒ–åœ–è¡¨ä¸¦ç›£è½æœˆä»½è®Šæ›´

**ä¸»è¦åŠŸèƒ½**:

```typescript
// è¨ˆç®—ç­‰æ•ˆå·¥æ™‚ï¼ˆä½¿ç”¨é†«å¸«ä»‹å…¥æ¯”ä¾‹æ¨¡å‹ï¼‰
const doctorRatio = ratios.doctor || 0;
if (doctorRatio > 0) {
  stats["doctor"].usedMinutes += totalMinutes * doctorRatio;
}

// ç¸½å·¥æ™‚è¨ˆç®—
const weeksInMonth = 4;
const totalHours = count * 8 * 7 * weeksInMonth;

// è² è¼‰ç‡è¨ˆç®—
const percentage =
  totalHours > 0 ? Math.round((usedHours / totalHours) * 100) : 0;
```

---

### 2. **ä¿®æ”¹æª”æ¡ˆ**

#### `index.html` (Line 477-496)

**è®Šæ›´å…§å®¹**:

- å°‡ `<div id="staffWorkloadBars">` æ”¹ç‚º `<canvas id="staffWorkloadChart">`
- ç§»é™¤é€±æœŸé¸æ“‡æŒ‰éˆ•ï¼ˆæœ¬é€±/ä¸‹é€±/æœªä¾† 30 å¤©ï¼‰
- æ›´æ–° footer èªªæ˜æ–‡å­—

**ä¿®æ”¹å‰**:

```html
<div id="staffWorkloadBars" class="workload-chart-container">
  <!-- JS Injected Bars -->
</div>
```

**ä¿®æ”¹å¾Œ**:

```html
<div class="chart-container" style="height: 400px; padding: 20px;">
  <canvas id="staffWorkloadChart"></canvas>
</div>
```

---

#### `src/pages/staffPage.ts` (Line 6, 20-21)

**è®Šæ›´å…§å®¹**:

- å°‡ `initWorkloadBarControls` æ”¹ç‚º `initStaffWorkloadChart`
- ç§»é™¤å° `appointments` åƒæ•¸çš„å‚³éï¼ˆæ–°åœ–è¡¨å¾ `dataStore` ç›´æ¥è®€å–ï¼‰

**ä¿®æ”¹å‰**:

```typescript
import { initWorkloadBarControls } from "../logic/staff/staffWorkloadBars.js";
// ...
initWorkloadBarControls(dataStore.appointments);
```

**ä¿®æ”¹å¾Œ**:

```typescript
import { initStaffWorkloadChart } from "../logic/staff/staffWorkloadChart.js";
// ...
initStaffWorkloadChart();
```

---

## ğŸ“Š åœ–è¡¨èªªæ˜

### åœ–è¡¨é¡å‹

- **é¡å‹**: åˆ†çµ„æŸ±ç‹€åœ– (Grouped Bar Chart)
- **X è»¸**: è·å‹™é¡åˆ¥ï¼ˆé†«å¸«ã€è«®è©¢å¸«ã€è­·ç†å¸«ã€ç¾ç™‚å¸«ï¼‰
- **Y è»¸**: å·¥æ™‚ï¼ˆå°æ™‚ï¼‰

### è³‡æ–™é›†

1. **å¯¦éš›å·¥æ™‚** (è—/ç´«/ç¶ /ç²‰è‰²)

   - æ ¹æ“šé†«å¸«ä»‹å…¥æ¯”ä¾‹æ¨¡å‹è¨ˆç®—çš„ç­‰æ•ˆå·¥æ™‚
   - æ¯å€‹è·å‹™ä½¿ç”¨ä¸åŒé¡è‰²

2. **ç¸½å·¥æ™‚** (ç°è‰²åŠé€æ˜)
   - è·å‹™ç¸½äººæ•¸ Ã— 8 å°æ™‚/å¤© Ã— 7 å¤©/é€± Ã— 4 é€±/æœˆ

### Tooltip é¡¯ç¤º

```
é†«å¸«
å¯¦éš›å·¥æ™‚ (å°æ™‚): 45.3 å°æ™‚ (è² è¼‰ç‡: 25%)
ç¸½å·¥æ™‚ (å°æ™‚): 224.0 å°æ™‚
```

---

## ğŸ¨ è¦–è¦ºæ•ˆæœ

### é¡è‰²é…ç½®

- **é†«å¸«**: è—è‰² `rgba(59, 130, 246, 0.8)`
- **è«®è©¢å¸«**: ç´«è‰² `rgba(139, 92, 246, 0.8)`
- **è­·ç†å¸«**: ç¶ è‰² `rgba(16, 185, 129, 0.8)`
- **ç¾ç™‚å¸«**: ç²‰è‰² `rgba(236, 72, 153, 0.8)`

### å­—é«”è¨­å®š

- æ¨™é¡Œ: 16px, ç²—é«”, Noto Sans TC
- åœ–ä¾‹: Noto Sans TC
- åº§æ¨™è»¸: Noto Sans TC, ç°è‰² (#6b7280)

---

## ğŸ’¡ è¨ˆç®—ç¯„ä¾‹

### ç¯„ä¾‹æƒ…å¢ƒ

- **ç›®æ¨™æœˆä»½**: 2025-12
- **åŸºæº–æ—¥**: 2025-12-16
- **é†«å¸«äººæ•¸**: 4 äººï¼ˆå¾ staff.csv è®€å– status='active'ï¼‰

### é ç´„è³‡æ–™

| æ—¥æœŸ       | ç™‚ç¨‹         | é¡åˆ¥    | æ™‚é•·  | ç‹€æ…‹      |
| ---------- | ------------ | ------- | ----- | --------- |
| 2025-12-10 | Botox        | inject  | 20 åˆ† | completed |
| 2025-12-15 | Pico Laser   | laser   | 40 åˆ† | completed |
| 2025-12-18 | Thermage     | rf      | 60 åˆ† | scheduled |
| 2025-12-20 | Consultation | consult | 25 åˆ† | scheduled |

### è¨ˆç®—éç¨‹

#### 1. ç¯©é¸é ç´„

- **2025-12-10** (completed): âœ… è¨ˆå…¥ï¼ˆä»Šå¤©ä¹‹å‰ä¸” completedï¼‰
- **2025-12-15** (completed): âœ… è¨ˆå…¥ï¼ˆä»Šå¤©ä¹‹å‰ä¸” completedï¼‰
- **2025-12-18** (scheduled): âœ… è¨ˆå…¥ï¼ˆä»Šå¤©ä¹‹å¾Œï¼Œå…¨éƒ¨è¨ˆå…¥ï¼‰
- **2025-12-20** (scheduled): âœ… è¨ˆå…¥ï¼ˆä»Šå¤©ä¹‹å¾Œï¼Œå…¨éƒ¨è¨ˆå…¥ï¼‰

#### 2. è¨ˆç®—é†«å¸«ç­‰æ•ˆå·¥æ™‚

- **Botox** (inject): 20 Ã— 0.35 = **7 åˆ†é˜**
- **Pico Laser** (laser): 40 Ã— 0.15 = **6 åˆ†é˜**
- **Thermage** (rf): 60 Ã— 0.35 = **21 åˆ†é˜**
- **Consultation** (consult): 25 Ã— 0.30 = **7.5 åˆ†é˜**

**é†«å¸«ç¸½ç­‰æ•ˆå·¥æ™‚**: 7 + 6 + 21 + 7.5 = **41.5 åˆ†é˜** = **0.69 å°æ™‚**

#### 3. è¨ˆç®—ç¸½å·¥æ™‚

- é†«å¸«äººæ•¸: 4 äºº
- ç¸½å·¥æ™‚ = 4 Ã— 8 Ã— 7 Ã— 4 = **896 å°æ™‚**

#### 4. è¨ˆç®—è² è¼‰ç‡

- è² è¼‰ç‡ = (0.69 / 896) Ã— 100 = **0.08%**

---

## ğŸ”„ æœˆä»½åŒæ­¥æ©Ÿåˆ¶

### åˆå§‹åŒ–æµç¨‹

```typescript
export function initStaffWorkloadChart(): void {
  // 1. å–å¾—å…¨åŸŸæœˆä»½é¸æ“‡å™¨
  const monthSelector = document.getElementById("global-month-selector");

  // 2. åˆå§‹æ¸²æŸ“ï¼ˆä½¿ç”¨ç•¶å‰é¸ä¸­çš„æœˆä»½ï¼‰
  const initialMonth = monthSelector.value || "2025-12";
  renderStaffWorkloadChart(initialMonth);

  // 3. ç›£è½æœˆä»½è®Šæ›´äº‹ä»¶
  monthSelector.addEventListener("change", () => {
    const selectedMonth = monthSelector.value;
    renderStaffWorkloadChart(selectedMonth);
  });
}
```

### è³‡æ–™æµ

```
ä½¿ç”¨è€…é¸æ“‡æœˆä»½
  â†“
global-month-selector change äº‹ä»¶è§¸ç™¼
  â†“
renderStaffWorkloadChart(selectedMonth)
  â†“
calculateStaffWorkloadData(appointments, selectedMonth)
  â†“
ç¯©é¸è©²æœˆä»½é ç´„ â†’ æ‡‰ç”¨æ—¥æœŸè¦å‰‡ â†’ è¨ˆç®—ç­‰æ•ˆå·¥æ™‚
  â†“
æ›´æ–°åœ–è¡¨
```

---

## âœ… é©—è­‰æª¢æŸ¥æ¸…å–®

- [x] ç¸½å·¥æ™‚è¨ˆç®—ï¼šè·å‹™ç¸½äººæ•¸ Ã— 8 å°æ™‚/å¤© Ã— 7 å¤©/é€± Ã— 4 é€±/æœˆ
- [x] å¯¦éš›å·¥æ™‚ç¯©é¸ï¼šä»Šå¤©ä¹‹å‰åªè¨ˆç®— completed
- [x] å¯¦éš›å·¥æ™‚ç¯©é¸ï¼šä»Šå¤©åŠä¹‹å¾Œè¨ˆç®—æ‰€æœ‰é ç´„
- [x] ä½¿ç”¨é†«å¸«ä»‹å…¥æ¯”ä¾‹æ¨¡å‹
- [x] èˆ‡å…¨åŸŸæœˆä»½é¸å–®åŒæ­¥
- [x] æ‰€æœ‰æ–‡å­—æ”¹ç‚ºç¹é«”ä¸­æ–‡
- [x] ä½¿ç”¨ Noto Sans TC å­—é«”
- [x] TypeScript ç·¨è­¯æˆåŠŸ
- [x] ç„¡ lint éŒ¯èª¤

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

1. **é–‹å•ŸäººåŠ›åˆ†æé é¢**

   - é»æ“Šå´é‚Šæ¬„ã€ŒäººåŠ›åˆ†æã€

2. **æŸ¥çœ‹åœ–è¡¨**

   - åœ–è¡¨æœƒè‡ªå‹•é¡¯ç¤ºç•¶å‰é¸ä¸­æœˆä»½çš„äººåŠ›è² è¼‰è³‡æ–™

3. **åˆ‡æ›æœˆä»½**

   - ä½¿ç”¨å³ä¸Šæ–¹æœˆä»½é¸å–®åˆ‡æ›
   - åœ–è¡¨æœƒè‡ªå‹•æ›´æ–°

4. **æŸ¥çœ‹è©³ç´°è³‡è¨Š**
   - æ»‘é¼ ç§»åˆ°æŸ±ç‹€åœ–ä¸ŠæŸ¥çœ‹ tooltip
   - é¡¯ç¤ºå¯¦éš›å·¥æ™‚ã€ç¸½å·¥æ™‚ã€è² è¼‰ç‡

---

## ğŸ“ æŠ€è¡“ç´°ç¯€

### æ—¥æœŸåŸºæº–

```typescript
const today = new Date("2025-12-16"); // å›ºå®šåŸºæº–æ—¥æœŸ
today.setHours(0, 0, 0, 0);
```

### é ç´„ç¯©é¸é‚è¼¯

```typescript
const filteredAppointments = monthAppointments.filter((apt) => {
  const aptDate = new Date(apt.date);
  aptDate.setHours(0, 0, 0, 0);

  if (aptDate < today) {
    // ä»Šå¤©ä¹‹å‰ï¼šåªè¨ˆç®— completed
    return apt.status === "completed";
  } else {
    // ä»Šå¤©åŠä¹‹å¾Œï¼šå…¨éƒ¨ç´å…¥
    return true;
  }
});
```

### è·å‹™äººæ•¸å‹•æ…‹è¨ˆç®—

```typescript
function getStaffCounts(): Record<string, number> {
  const counts = { doctor: 0, consultant: 0, nurse: 0, therapist: 0 };

  dataStore.staff.forEach((staff) => {
    if (staff.status === "active" || staff.status === "Active") {
      const type = staff.staff_type;
      if (counts[type] !== undefined) {
        counts[type]++;
      }
    }
  });

  return counts;
}
```

---

## ğŸ¯ é æœŸæ•ˆæœ

### åœ–è¡¨é¡¯ç¤º

- 4 å€‹è·å‹™çš„åˆ†çµ„æŸ±ç‹€åœ–
- æ¯å€‹è·å‹™é¡¯ç¤ºã€Œå¯¦éš›å·¥æ™‚ã€å’Œã€Œç¸½å·¥æ™‚ã€
- å¯¦éš›å·¥æ™‚ä½¿ç”¨è·å‹™å°ˆå±¬é¡è‰²
- ç¸½å·¥æ™‚ä½¿ç”¨ç°è‰²åŠé€æ˜

### è² è¼‰ç‡

- é†«å¸«è² è¼‰ç‡æœƒæ¯”ä¹‹å‰**æ›´ä½**ï¼ˆå› ç‚ºä½¿ç”¨ä»‹å…¥æ¯”ä¾‹ï¼‰
- è«®è©¢å¸«è² è¼‰ç‡æœƒ**å‡ºç¾**ï¼ˆConsultation ç¾åœ¨è¨ˆå…¥ï¼‰
- ç¾ç™‚å¸«/è­·ç†å¸«è² è¼‰ç‡**ç¶­æŒåˆç†**

### äº’å‹•æ€§

- æœˆä»½åˆ‡æ›å³æ™‚æ›´æ–°
- Tooltip é¡¯ç¤ºè©³ç´°è³‡è¨Š
- éŸ¿æ‡‰å¼è¨­è¨ˆ

---

## ğŸ”§ ç–‘é›£æ’è§£

### åœ–è¡¨ä¸é¡¯ç¤º

1. æª¢æŸ¥ `#staffWorkloadChart` canvas æ˜¯å¦å­˜åœ¨
2. æª¢æŸ¥ `#global-month-selector` æ˜¯å¦å­˜åœ¨
3. æª¢æŸ¥ console æ˜¯å¦æœ‰éŒ¯èª¤è¨Šæ¯

### è³‡æ–™ä¸æ­£ç¢º

1. æª¢æŸ¥ `dataStore.appointments` æ˜¯å¦å·²è¼‰å…¥
2. æª¢æŸ¥ `dataStore.staff` æ˜¯å¦å·²è¼‰å…¥
3. æª¢æŸ¥ `dataStore.services` æ˜¯å¦å·²è¼‰å…¥

### æœˆä»½åŒæ­¥å¤±æ•—

1. ç¢ºèª `global-month-selector` çš„ value æ ¼å¼ç‚º `YYYY-MM`
2. ç¢ºèª change äº‹ä»¶ç›£è½å™¨å·²æ­£ç¢ºç¶å®š

---

**è®Šæ›´æ—¥æœŸ**: 2025-12-16  
**è®Šæ›´è€…**: Antigravity AI  
**ç‰ˆæœ¬**: v2.0
