# 預約量預測系統 - 資料處理補充說明

## 📋 資料處理原則

### 核心概念

```
已知預約（圖表顯示）= 所有狀態（completed + no_show + cancelled）
預測學習（模型訓練）= 只使用 completed 狀態
```

---

## 🎯 為什麼這樣設計？

### 1. **已知預約顯示所有狀態**

#### 原因

- 反映真實預約情況
- 包含所有已排定的預約
- 幫助營運者了解總預約量

#### 包含狀態

- ✅ `completed` - 已完成
- ✅ `no_show` - 未到診
- ✅ `cancelled` - 已取消

#### 範例

```
12/15 (日) 實際預約
- completed: 15 筆
- no_show: 2 筆
- cancelled: 1 筆
總計顯示: 18 筆
```

---

### 2. **預測學習只用 completed**

#### 原因

- 反映實際到診情況
- 避免 no_show 和 cancelled 干擾預測
- 提供更準確的未來預測

#### 學習資料

- ✅ `completed` - 已完成（實際到診）
- ❌ `no_show` - 未到診（不計入）
- ❌ `cancelled` - 已取消（不計入）

#### 範例

```
學習資料（12/15）
- 總預約: 18 筆
- 用於學習: 15 筆（只計 completed）
- 基準計算: 基於 15 筆
```

---

## 📊 資料流程圖

```
歷史預約資料
    │
    ├─→ 顯示用（所有狀態）
    │   └─→ 圖表藍色實線
    │       - completed: 15
    │       - no_show: 2
    │       - cancelled: 1
    │       總計: 18 筆
    │
    └─→ 學習用（只 completed）
        └─→ 預測模型
            - 基準計算: 15 筆
            - 星期係數: 基於 15 筆
            - 季節調整: 基於 15 筆
            └─→ 未來預測
                - 紫色虛線
                - 橙色虛線（趨勢）
```

---

## 🔧 技術實現

### 顯示所有狀態

```typescript
// 處理歷史資料：顯示所有狀態（completed, no_show, cancelled）
const historicalCounts: Record<string, number> = {};
appointments.forEach((apt) => {
  if (!historicalCounts[apt.date]) historicalCounts[apt.date] = 0;
  historicalCounts[apt.date]++; // 所有狀態都計入
});
```

### 學習只用 completed

```typescript
// 篩選 completed 的預約用於學習
const completedAppointments = appointments.filter(
  (apt) => apt.status === "completed"
);

// 統計每日 completed 預約量
const dailyCounts: Record<string, number> = {};
completedAppointments.forEach((apt) => {
  if (!dailyCounts[apt.date]) dailyCounts[apt.date] = 0;
  dailyCounts[apt.date]++;
});
```

---

## 💡 實際範例

### 情境：2025 年 12 月資料

#### 原始資料

| 日期  | completed | no_show | cancelled | 總計 |
| ----- | --------- | ------- | --------- | ---- |
| 12/10 | 15        | 2       | 1         | 18   |
| 12/11 | 18        | 1       | 0         | 19   |
| 12/12 | 20        | 3       | 2         | 25   |
| 12/13 | 16        | 2       | 1         | 19   |
| 12/14 | 22        | 1       | 1         | 24   |

#### 圖表顯示（藍色實線）

```
12/10: 18 筆
12/11: 19 筆
12/12: 25 筆
12/13: 19 筆
12/14: 24 筆
```

#### 學習資料（用於預測）

```
12/10: 15 筆 (completed)
12/11: 18 筆 (completed)
12/12: 20 筆 (completed)
12/13: 16 筆 (completed)
12/14: 22 筆 (completed)

基準計算:
- 中位數: 18
- 平均數: 18.2
- 基準: 18 × 0.7 + 18.2 × 0.3 = 18.06 筆
```

#### 未來預測（12/20 週五）

```
基準: 18.06
季節係數: 1.5 (12月高峰)
星期係數: 1.0 (週五)
隨機變化: +3%

預測 = 18.06 × 1.5 × 1.0 × 1.03 = 27.9 ≈ 28 筆
```

---

## 📈 對比分析

### 如果學習時包含所有狀態

```
基準計算（錯誤方式）:
- 平均: (18+19+25+19+24)/5 = 21 筆

預測 (12/20):
21 × 1.5 × 1.0 = 31.5 ≈ 32 筆

問題:
- 高估了實際到診量
- 包含了 no_show 和 cancelled
- 預測不準確
```

### 正確方式（只用 completed）

```
基準計算（正確方式）:
- 平均: (15+18+20+16+22)/5 = 18.2 筆

預測 (12/20):
18.2 × 1.5 × 1.0 = 27.3 ≈ 27 筆

優點:
- 反映實際到診量
- 排除 no_show 和 cancelled 干擾
- 預測更準確
```

---

## ✅ 驗證方式

### Console 輸出

```javascript
📊 歷史資料分析 (completed): 中位數=18.0, 平均=18.2, 基準=18.1
📅 星期係數 (completed): {0: 1.15, 1: 0.95, ..., 6: 1.2}
🔮 預測生成完成: 30天, 基準=18.1
```

### 圖表檢查

1. **藍色實線（實際預約）**

   - 數值 = completed + no_show + cancelled
   - 顯示總預約量

2. **橙色虛線（趨勢預測）**

   - 基於 completed 資料學習
   - 顯示可能的趨勢變化

3. **紫色虛線（未來預測）**
   - 基於 completed 資料學習
   - 應用季節規律

---

## 🎯 使用建議

### 營運決策

1. **查看藍色實線**

   - 了解總預約量
   - 包含所有已排定預約

2. **參考紫色虛線**

   - 預測未來到診量
   - 基於實際到診歷史

3. **對比兩者差異**
   - 如果實際 > 預測：可能有促銷活動
   - 如果實際 < 預測：可能進入淡季

### 人力規劃

```
使用預測值（紫色虛線）規劃人力
- 預測基於實際到診量（completed）
- 更準確反映實際需求
- 避免 no_show 造成的人力浪費
```

---

## 📝 總結

### 關鍵原則

```
顯示 = 所有狀態（完整資訊）
學習 = completed（準確預測）
```

### 優點

1. ✅ 顯示完整預約情況
2. ✅ 預測基於實際到診
3. ✅ 避免 no_show 干擾
4. ✅ 提供準確預測

### 實際效果

- 圖表顯示真實預約量
- 預測反映實際到診量
- 幫助營運者做出正確決策

---

**更新日期**: 2025-12-16  
**版本**: v1.1  
**狀態**: ✅ 已完成並測試
