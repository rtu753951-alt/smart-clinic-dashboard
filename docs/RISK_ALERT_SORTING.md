# AI 風險預警 - 排序邏輯更新

## ✅ 更新內容

### 1. 摘要版排序

**修正前：**

- 優先顯示人力風險
- 再顯示療程風險
- 不考慮風險等級

**修正後：**

- 所有風險（人力 + 療程）混合排序
- 按風險等級排序：🔴 critical > 🟠 warning > ⚪ normal > 🔵 low
- 取前 4 個最高風險顯示

### 2. 詳細版排序

**人力風險（個人層級）：**

- 按風險等級排序：critical > warning > low
- 🔴 過載風險優先顯示
- 🟠 負載偏高次之
- 🔵 利用率偏低最後

**療程風險（療程層級）：**

- 按風險等級排序：critical > warning > normal
- 🔴 無可執行人力、單點人力優先
- 🟠 技能斷層、品質穩定性次之

**整合顯示：**

- 所有風險混合排序
- 不分人力或療程
- 純粹按風險等級高低排列

## 📊 排序範例

### 摘要版（卡片）

```
🚨 AI 風險預警（摘要）

🔴 Pico Laser 高度集中風險（僅 1 人可執行）
🔴 陳醫師（doctor）人力負載過高
🟠 Thermage 技能斷層風險（僅 1 位資深人員）
🟠 李醫師（doctor）人力負載偏高
```

### 詳細版（彈窗）

```
👤 一、人力風險（個人層級）

🔴 陳醫師（doctor）人力負載過高
  風險說明：陳醫師 本月負載率達 92%，已接近或超過可承受上限
  ...

🟠 李醫師（doctor）人力負載偏高
  風險說明：李醫師 本月負載率為 75%，接近高檔
  ...

🔵 黃諮詢師（consultant）人力利用率偏低
  風險說明：黃諮詢師 本月負載率僅 25%，明顯偏低
  ...

💉 二、療程風險（療程層級）

🔴 Pico Laser 高度集中風險（僅 1 人可執行）
  風險說明：Pico Laser 僅由 王美療師（senior）執行，任何請假或異動將直接影響服務
  ...

🟠 Thermage 技能斷層風險（僅 1 位資深人員）
  風險說明：Thermage 有 2 位可執行人員，但僅 1 位資深人員，缺乏技術傳承與備援
  ...
```

## 🎯 排序規則

### 風險等級優先順序

| 等級     | 圖示 | 優先度    | 說明                     |
| -------- | ---- | --------- | ------------------------ |
| critical | 🔴   | 1（最高） | 需要立即處理的嚴重風險   |
| warning  | 🟠   | 2         | 需要持續觀察的中度風險   |
| normal   | ⚪   | 3         | 正常狀態，無需特別處理   |
| low      | 🔵   | 4（最低） | 利用率偏低等低優先度問題 |

### 排序實作

```typescript
// 整合層排序（所有風險）
allAlerts.sort((a, b) => {
  const order = { critical: 0, warning: 1, normal: 2, low: 3 };
  return order[a.level] - order[b.level];
});

// 摘要取前 4 個
const summary = allAlerts
  .slice(0, 4)
  .map((alert) => `${alert.icon} ${alert.summary}`);
```

## 📝 使用者體驗改善

### 改善前

- 人力風險和療程風險分開顯示
- 可能先看到低風險的人力問題
- 高風險的療程問題被埋在後面

### 改善後

- 所有風險統一排序
- 最嚴重的問題優先顯示
- 管理者一眼就能看到最需要處理的問題

## ✅ 測試方式

1. **重新整理瀏覽器**（Ctrl+Shift+R）
2. **查看 AI 風險預警卡片**

   - 確認顯示的 4 個風險都是最高等級
   - 🔴 critical 應該在最前面
   - 🟠 warning 次之
   - 🔵 low 在最後（如果有的話）

3. **點擊卡片查看詳細版**
   - 確認「人力風險」區塊內部按等級排序
   - 確認「療程風險」區塊內部按等級排序
   - 整體順序應該是最嚴重的問題在最上面

---

_更新時間：2025-12-15_
_版本：v3.2_
