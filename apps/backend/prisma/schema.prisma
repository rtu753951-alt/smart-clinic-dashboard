generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Import {
  id               String                  @id @default(uuid())
  filename         String
  file_hash        String?
  imported_at      DateTime                @default(now())
  status           String
  dataset          String?
  source           String                  @default("upload_csv")
  mode             String                  @default("replace")
  started_at       DateTime?
  finished_at      DateTime?
  duration_ms      Int?
  error_summary    String?
  valid_count      Int                     @default(0)
  quarantine_count Int                     @default(0)
  warning_count    Int                     @default(0)
  report_json      String                  @default("{\"issues\":[]}")
  appointments     Appointment[]
  quarantined      QuarantineAppointment[]

  @@index([imported_at])
  @@index([file_hash]) // 建議加這個，後面查重更快
}

model Staff {
  id                 String        @id @default(uuid())
  staff_name         String        @unique
  staff_type         String
  specialty          String?
  skill_level        String?
  certified_services String?
  status             String        @default("active")
  appointments       Appointment[]
}

model Service {
  id              String        @id @default(uuid())
  service_name    String        @unique
  category        String?
  price           Float?
  duration        Int?
  buffer_time     Int?
  executor_role   String?
  intensity_level String?
  transferable    Boolean?      @default(false)
  appointments    Appointment[]
}

model Appointment {
  id                 String   @id @default(uuid())
  appointment_id     String   @unique
  import_id          String
  date               String
  time               String?
  status             String
  customer_id        String?
  doctor_id          String?
  doctor_name        String?
  staff_role         String?
  service_id         String?
  service_item       String?
  purchased_services String?
  room               String?
  equipment          String?
  raw_source         String?
  age                Int?
  gender             String?
  is_new             Boolean?
  service            Service? @relation(fields: [service_id], references: [id])
  doctor             Staff?   @relation(fields: [doctor_id], references: [id])
  import             Import   @relation(fields: [import_id], references: [id])

  @@index([date])
  @@index([status])
  @@index([import_id])
}

model QuarantineAppointment {
  id             String   @id @default(uuid())
  import_id      String
  created_at     DateTime @default(now())
  row_index      Int
  appointment_id String?
  raw_data       String
  issues_json    String
  import         Import   @relation(fields: [import_id], references: [id])

  @@index([import_id])
  @@index([created_at])
}
